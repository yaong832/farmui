<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë†ì¥ ë°ì´í„° ë¶„ì„ ì‹œìŠ¤í…œ</title>
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'ë§‘ì€ ê³ ë”•', 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        
        /* í—¤ë” ë°” */
        .header-bar {
            background: #1a1a2e;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .header-icons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .header-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            color: white;
            font-size: 20px;
        }
        
        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        /* ì™¼ìª½ íŒ¨ë„ - ë°ì´í„° ë¡œê·¸ */
        .data-log-panel {
            flex: 1;
            background: white;
            margin: 15px;
            margin-right: 7.5px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-header h2 {
            font-size: 20px;
            color: #333;
            font-weight: 600;
            margin: 0;
        }
        
        .log-actions {
            display: flex;
            gap: 8px;
        }
        
        .log-action-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .log-action-btn:hover {
            background: #45a049;
        }
        
        .log-action-btn span {
            margin-right: 4px;
        }
        
        .data-log-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
            max-height: 50%;
        }
        
        /* ê·¸ë˜í”„ ì„¹ì…˜ */
        .chart-section {
            height: 50%;
            border-top: 2px solid #e0e0e0;
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-header {
            margin-bottom: 10px;
        }
        
        .chart-header h3 {
            font-size: 16px;
            color: #333;
            font-weight: 600;
            margin: 0;
        }
        
        .chart-container {
            flex: 1;
            position: relative;
            min-height: 250px;
        }
        
        .log-entry {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-timestamp {
            color: #666;
            margin-right: 15px;
        }
        
        .log-data {
            display: inline-block;
            margin-right: 20px;
        }
        
        .log-label {
            color: #888;
            margin-right: 5px;
        }
        
        .log-value {
            color: #333;
            font-weight: 500;
        }
        
        /* ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” */
        .ai-sidebar {
            width: 350px;
            background: white;
            margin: 15px;
            margin-left: 7.5px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* AI í’ˆì§ˆ ë¶„ì„ ì„¹ì…˜ */
        .ai-analysis-section {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .ai-analysis-section h2 {
            font-size: 18px;
            color: #333;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .average-data {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
        }
        
        .average-data-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .metric-item:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #555;
            font-size: 14px;
        }
        
        .metric-value {
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* ë²„íŠ¼ ì„¹ì…˜ */
        .button-section {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
            border-left: 2px solid #e0e0e0;
        }
        
        .analysis-mode-section {
            padding: 18px 20px;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            border-radius: 8px 8px 0 0;
            margin-bottom: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .mode-label {
            font-size: 15px;
            color: #495057;
            font-weight: 600;
            min-width: 80px;
        }
        
        .mode-select {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .mode-select:hover {
            border-color: #4CAF50;
            background: #f0f8f0;
        }
        
        .mode-select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.15);
        }
        
        .action-button {
            width: 100%;
            padding: 16px 22px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(76, 175, 80, 0.25);
            text-transform: none;
            letter-spacing: 0.3px;
        }
        
        .action-button:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(76, 175, 80, 0.35);
        }
        
        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.25);
        }
        
        .action-button .icon {
            font-size: 20px;
        }
        
        
        /* ê²°ê³¼ í‘œì‹œ ì˜ì—­ */
        .result-container {
            padding: 20px;
            border-top: 2px solid #e0e0e0;
            max-height: 600px;
            min-height: 400px;
            overflow-y: auto;
            display: none;
            background: #fafafa;
            border-radius: 0 0 8px 8px;
        }
        
        .result-container.active {
            display: block;
        }
        
        .result-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }
        
        .result-content {
            font-size: 14px;
            color: #34495e;
            line-height: 1.8;
            white-space: pre-wrap;
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .data-log-content::-webkit-scrollbar,
        .result-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .data-log-content::-webkit-scrollbar-track,
        .result-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .data-log-content::-webkit-scrollbar-thumb,
        .result-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .data-log-content::-webkit-scrollbar-thumb:hover,
        .result-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- í—¤ë” ë°” -->
    <div class="header-bar">
        <div class="header-title">
            AI ë†ì¥ ë°ì´í„° ë¶„ì„ ì‹œìŠ¤í…œ
            <span id="farmInfo" style="font-size: 14px; margin-left: 15px; color: #a0a0a0; font-weight: normal;">
                (ìŠ¤ë§ˆíŠ¸íŒœ <span id="currentFarmNumber">1</span>ë²ˆ - <span id="currentCropName">ë¡œë”© ì¤‘...</span>)
            </span>
        </div>
        <div class="header-icons">
            <div class="header-icon">âš™ï¸</div>
            <div class="header-icon">ğŸ </div>
        </div>
    </div>
    
    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="main-container">
        <!-- ì™¼ìª½ íŒ¨ë„ - ë°ì´í„° ë¡œê·¸ -->
        <div class="data-log-panel">
            <div class="panel-header">
                <h2>ë°ì´í„° ë¡œê·¸</h2>
                <div class="log-actions">
                    <button class="log-action-btn" onclick="loadLogFile()" title="ë¡œê·¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°">
                        <span>ğŸ“‚</span> ë¶ˆëŸ¬ì˜¤ê¸°
                    </button>
                    <button class="log-action-btn" onclick="saveLogFile()" title="ë¡œê·¸ íŒŒì¼ ì €ì¥">
                        <span>ğŸ’¾</span> ì €ì¥
                    </button>
                </div>
            </div>
            <div class="data-log-content" id="dataLogContent">
                <div class="empty-state">ë°ì´í„° ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            
            <!-- ê·¸ë˜í”„ ì„¹ì…˜ -->
            <div class="chart-section">
                <div class="chart-header">
                    <h3>ì„¼ì„œ ë°ì´í„° ê·¸ë˜í”„</h3>
                </div>
                <div class="chart-container">
                    <canvas id="sensorChart"></canvas>
                </div>
            </div>
            
            <input type="file" id="logFileInput" accept=".txt" style="display: none;" onchange="handleLogFileSelect(event)">
        </div>
        
        <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” -->
        <div class="ai-sidebar">
            <!-- AI í’ˆì§ˆ ë¶„ì„ ì„¹ì…˜ -->
            <div class="ai-analysis-section">
                <h2>AI í’ˆì§ˆ ë¶„ì„</h2>
                <div class="average-data">
                    <div class="average-data-title">í‰ê·  ë°ì´í„°</div>
                    <div class="metric-item">
                        <span class="metric-label">ì˜¨ë„</span>
                        <span class="metric-value" id="avgTemperature">-</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">ìŠµë„</span>
                        <span class="metric-value" id="avgHumidity">-</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">ì±„ê´‘</span>
                        <span class="metric-value" id="avgLight">-</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">í† ì–‘ ìŠµë„</span>
                        <span class="metric-value" id="avgSoilMoisture">-</span>
                    </div>
                </div>
            </div>
            
            <!-- ë¶„ì„ ëª¨ë“œ ì„ íƒ -->
            <div class="analysis-mode-section">
                <label class="mode-label">ë¶„ì„ ëª¨ë“œ:</label>
                <select id="analysisMode" class="mode-select" onchange="onAnalysisModeChange()">
                    <option value="realtime">ì‹¤ì‹œê°„ ë°ì´í„°</option>
                    <option value="logs">ë¡œê·¸ íŒŒì¼</option>
                </select>
            </div>
            
            <!-- ë²„íŠ¼ ì„¹ì…˜ -->
            <div class="button-section">
                <button class="action-button" onclick="analyzeAverage()">
                    <span class="icon">ğŸ“Š</span>
                    <span>í‰ê·  ë°ì´í„° ë¶„ì„</span>
                </button>
                <button class="action-button" onclick="detectAnomalies()">
                    <span class="icon">âš ï¸</span>
                    <span>ì´ìƒ ì§•í›„ ê°ì§€</span>
                </button>
            </div>
            
            <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
            <div class="result-container" id="resultContainer">
                <div class="result-title" id="resultTitle"></div>
                <div class="result-content" id="resultContent"></div>
            </div>
        </div>
    </div>

    <script>
        // ë†ì¥ ì •ë³´ ì „ì—­ ë³€ìˆ˜
        let currentFarmData = {
            currentFarm: 1,
            farms: []
        };
        
        // ê° íŒœì˜ ë°ì´í„° ë¡œê·¸ë¥¼ ë©”ëª¨ë¦¬ì— ë³„ë„ë¡œ ì €ì¥ (ì‹¤ì‹œê°„ ë°ì´í„° ìœ ì§€)
        let farmLogs = {
            1: [],  // íŒœ 1ë²ˆì˜ ë¡œê·¸ í•­ëª©ë“¤
            2: [],  // íŒœ 2ë²ˆì˜ ë¡œê·¸ í•­ëª©ë“¤
            3: []   // íŒœ 3ë²ˆì˜ ë¡œê·¸ í•­ëª©ë“¤
        };
        
        // ë¡œê·¸ ê´€ë¦¬ ì„¤ì •
        const LOG_CONFIG = {
            maxLogsPerFarm: 200,        // íŒœë‹¹ ìµœëŒ€ ë¡œê·¸ ê°œìˆ˜ (ë©”ëª¨ë¦¬)
            maxDisplayLogs: 100,        // í™”ë©´ì— í‘œì‹œí•  ìµœëŒ€ ë¡œê·¸ ê°œìˆ˜
            maxStorageLogs: 500,        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•  ìµœëŒ€ ë¡œê·¸ ê°œìˆ˜
            cleanupInterval: 300000,    // 5ë¶„ë§ˆë‹¤ ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬ (ë°€ë¦¬ì´ˆ)
            maxLogAge: 24 * 60 * 60 * 1000,  // ìµœëŒ€ ë¡œê·¸ ë³´ê´€ ê¸°ê°„ (24ì‹œê°„, ë°€ë¦¬ì´ˆ)
            autoSaveBeforeCleanup: true  // ì •ë¦¬ ì „ì— ìë™ìœ¼ë¡œ íŒŒì¼ë¡œ ì €ì¥í• ì§€ ì—¬ë¶€
        };
        
        // ë†ì¥ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateFarmInfo() {
            fetch('/api/farm')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // ë†ì¥ ë°ì´í„° ì €ì¥
                    currentFarmData = data;
                    
                    // í—¤ë”ì— ë†ì¥ ì •ë³´ í‘œì‹œ
                    const currentFarm = data.currentFarm || 1;
                    const farms = data.farms || [];
                    const currentFarmInfo = farms.find(f => f.id === currentFarm);
                    const cropName = currentFarmInfo ? (currentFarmInfo.cropName || 'ë¡œë”© ì¤‘...') : 'ë¡œë”© ì¤‘...';
                    
                    const farmNumberEl = document.getElementById('currentFarmNumber');
                    const cropNameEl = document.getElementById('currentCropName');
                    
                    if (farmNumberEl) {
                        farmNumberEl.textContent = currentFarm;
                    }
                    if (cropNameEl) {
                        cropNameEl.textContent = cropName;
                    }
                    
                    // ë†ì¥ ì •ë³´ ì—…ë°ì´íŠ¸ í›„ í˜„ì¬ ë†ì¥ì˜ ë°ì´í„° ë¡œê·¸ í‘œì‹œ (ì´ˆê¸° ë¡œë“œ ì‹œ)
                    if (currentFarm && !window.farmDataLogRestored) {
                        // ë©”ëª¨ë¦¬ì— ë¡œê·¸ê°€ ì—†ìœ¼ë©´ ë°±ì—…ì—ì„œ ë³µì› ì‹œë„
                        if (!farmLogs[currentFarm] || farmLogs[currentFarm].length === 0) {
                            restoreFarmDataLog(currentFarm);
                        } else {
                            displayFarmLog(currentFarm);
                        }
                        window.farmDataLogRestored = true;
                    }
                })
                .catch(error => {
                    console.error('ë†ì¥ ì •ë³´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                });
        }
        
        function updateSensorData() {
            // ë¶„ì„ ëª¨ë“œê°€ ë¡œê·¸ íŒŒì¼ì´ë©´ ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì§‘ ì¤‘ë‹¨
            if (analysisMode === 'logs') {
                return;
            }
            
            fetch('/api/sensors')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì„¼ì„œê°€ ë¹„ì–´ìˆìœ¼ë©´ ìŠ¤í‚µ
                    if (data && data.sensors && data.sensors.length > 0) {
                        // ì„¼ì„œ ë°ì´í„°ì˜ currentFarmì´ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë†ì¥ ì •ë³´ë„ ì—…ë°ì´íŠ¸
                        if (data.currentFarm !== currentFarmData.currentFarm) {
                            // ë†ì¥ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œ: ê¸°ì¡´ ë†ì¥ì˜ ë°ì´í„° ë¡œê·¸ ì €ì¥
                            if (currentFarmData.currentFarm) {
                                saveFarmDataLog(currentFarmData.currentFarm);
                            }
                            // ìƒˆ ë†ì¥ì˜ ë°ì´í„° ë¡œê·¸ ë³µì›
                            restoreFarmDataLog(data.currentFarm);
                            updateFarmInfo();
                        }
                        updateDataLog(data);
                        updateAverageData(data);
                        updateChart(data);  // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
                    } else {
                        console.warn('âš ï¸ ì„¼ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. C# UIê°€ ì‹¤í–‰ ì¤‘ì´ê³  Flask ì„œë²„ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
                        
                        // ì‚¬ìš©ìì—ê²Œ í‘œì‹œ (ì²˜ìŒ í•œ ë²ˆë§Œ)
                        if (!window.dataWarningShown) {
                            const container = document.getElementById('dataLogContent');
                            if (container && container.children.length === 0) {
                                const warningMsg = document.createElement('div');
                                warningMsg.className = 'log-entry';
                                warningMsg.style.color = '#ff6b6b';
                                warningMsg.innerHTML = '<span style="font-weight: bold;">âš ï¸ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span><br>' +
                                    '1. C# UIê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”<br>' +
                                    '2. C# UIì˜ "ì›¹ ì—°ê²°" ë²„íŠ¼ì„ ëˆŒëŸ¬ Flask ì„œë²„ì— ì—°ê²°í•˜ì„¸ìš”<br>' +
                                    '3. C# UIì˜ ì „ì›ì´ ì¼œì ¸ ìˆê³  PLC ì—°ê²°ì´ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”';
                                container.appendChild(warningMsg);
                                window.dataWarningShown = true;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('ì„¼ì„œ ë°ì´í„° ì˜¤ë¥˜:', error);
                    // ì—ëŸ¬ í‘œì‹œ (ì„ íƒì‚¬í•­)
                    // showStatusMessage('ì„¼ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message, 'error');
                });
        }
        
        // í˜„ì¬ ì„ íƒëœ íŒœì˜ ë¡œê·¸ë¥¼ í™”ë©´ì— í‘œì‹œ
        function displayFarmLog(farmId) {
            if (!farmId) return;
            
            const container = document.getElementById('dataLogContent');
            if (!container) return;
            
            // í•´ë‹¹ íŒœì˜ ë¡œê·¸ í•­ëª©ë“¤ì„ í™”ë©´ì— í‘œì‹œ (í‘œì‹œ ì œí•œ ì ìš©)
            const allLogs = farmLogs[farmId] || [];
            const logs = allLogs.slice(0, LOG_CONFIG.maxDisplayLogs);  // í™”ë©´ì—ëŠ” ìµœëŒ€ ê°œìˆ˜ë§Œ í‘œì‹œ
            
            // ë†ì¥ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const farms = currentFarmData.farms || [];
            const farmInfo = farms.find(f => f.id === farmId);
            const cropName = farmInfo ? (farmInfo.cropName || 'ê¸°ë³¸') : 'ê¸°ë³¸';
            
            // í—¤ë” ì¶”ê°€ (íŒœ êµ¬ë¶„ì„ ìœ„í•œ)
            let html = `<div class="farm-log-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; margin-bottom: 8px; border-radius: 4px; font-weight: bold; font-size: 14px;">
                ğŸ  ìŠ¤ë§ˆíŠ¸íŒœ ${farmId}ë²ˆ - ${cropName} (ì‹¤ì‹œê°„ ë°ì´í„°)
                ${allLogs.length > LOG_CONFIG.maxDisplayLogs ? `<span style="font-size: 11px; opacity: 0.9;">(${allLogs.length}ê°œ ì¤‘ ìµœì‹  ${LOG_CONFIG.maxDisplayLogs}ê°œ í‘œì‹œ)</span>` : `<span style="font-size: 11px; opacity: 0.9;">(${allLogs.length}ê°œ)</span>`}
            </div>`;
            
            // ë¡œê·¸ í•­ëª©ë“¤ ì¶”ê°€
            logs.forEach(logEntry => {
                html += logEntry;
            });
            
            container.innerHTML = html;
            console.log(`âœ… íŒœ ${farmId}ì˜ ë¡œê·¸ í‘œì‹œ (ì „ì²´: ${allLogs.length}ê°œ, í‘œì‹œ: ${logs.length}ê°œ)`);
        }
        
        // ë†ì¥ë³„ ë°ì´í„° ë¡œê·¸ ì €ì¥ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ - ë°±ì—…ìš©)
        function saveFarmDataLog(farmId) {
            if (!farmId) return;
            
            const logs = farmLogs[farmId] || [];
            if (logs.length === 0) return;
            
            // ì €ì¥í•  ë¡œê·¸ ê°œìˆ˜ ì œí•œ (ì˜¤ë˜ëœ ë¡œê·¸ëŠ” ì œì™¸)
            const logsToSave = logs.slice(0, LOG_CONFIG.maxStorageLogs);
            const logHtml = logsToSave.join('');
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ë°±ì—…ìš©)
            try {
                localStorage.setItem(`farm_log_${farmId}`, logHtml);
                console.log(`âœ… ë†ì¥ ${farmId}ì˜ ë°ì´í„° ë¡œê·¸ ë°±ì—… ì™„ë£Œ (${logsToSave.length}/${logs.length}ê°œ í•­ëª© ì €ì¥)`);
            } catch (e) {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ìš©ëŸ‰ ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ë¡œê·¸ ì‚­ì œ í›„ ì¬ì‹œë„
                if (e.name === 'QuotaExceededError') {
                    console.warn(`âš ï¸ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ìš©ëŸ‰ ì´ˆê³¼. ì˜¤ë˜ëœ ë¡œê·¸ë¥¼ ì‚­ì œí•˜ê³  ì¬ì‹œë„í•©ë‹ˆë‹¤.`);
                    // ë” ì ì€ ì–‘ìœ¼ë¡œ ì¬ì‹œë„
                    const reducedLogs = logs.slice(0, Math.floor(LOG_CONFIG.maxStorageLogs * 0.5));
                    try {
                        localStorage.setItem(`farm_log_${farmId}`, reducedLogs.join(''));
                        console.log(`âœ… ë†ì¥ ${farmId}ì˜ ë°ì´í„° ë¡œê·¸ ë°±ì—… ì™„ë£Œ (ìš©ëŸ‰ ì ˆì•½: ${reducedLogs.length}ê°œ í•­ëª©)`);
                    } catch (e2) {
                        console.error('ë°ì´í„° ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨ (ìš©ëŸ‰ ë¶€ì¡±):', e2);
                    }
                } else {
                    console.error('ë°ì´í„° ë¡œê·¸ ì €ì¥ ì˜¤ë¥˜:', e);
                }
            }
        }
        
        // ì˜¤ë˜ëœ ë¡œê·¸ë¥¼ íŒŒì¼ë¡œ ìë™ ì €ì¥í•˜ëŠ” í•¨ìˆ˜
        async function autoSaveOldLogs(farmId, oldLogs) {
            if (!LOG_CONFIG.autoSaveBeforeCleanup || oldLogs.length === 0) {
                return;
            }
            
            try {
                const farms = currentFarmData.farms || [];
                const farmInfo = farms.find(f => f.id === farmId);
                const cropName = farmInfo ? (farmInfo.cropName || 'ê¸°ë³¸') : 'ê¸°ë³¸';
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                
                // ì˜¤ë˜ëœ ë¡œê·¸ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
                let logContent = '';
                oldLogs.forEach(logHtml => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = logHtml;
                    const logEntry = tempDiv.querySelector('.log-entry');
                    if (logEntry) {
                        logContent += logEntry.textContent + '\n';
                    }
                });
                
                if (logContent.trim() !== '') {
                    // íŒŒì¼ë¡œ ì €ì¥ (ìë™ ë‹¤ìš´ë¡œë“œ)
                    const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `SmartFarm_íŒœ${farmId}_${cropName}_ìë™ì €ì¥_${timestamp}.txt`;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    console.log(`ğŸ’¾ íŒœ ${farmId}ì˜ ì˜¤ë˜ëœ ë¡œê·¸ ${oldLogs.length}ê°œë¥¼ ìë™ ì €ì¥í–ˆìŠµë‹ˆë‹¤.`);
                }
            } catch (e) {
                console.error(`íŒœ ${farmId} ìë™ ì €ì¥ ì˜¤ë¥˜:`, e);
            }
        }
        
        // ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬ í•¨ìˆ˜
        async function cleanupOldLogs() {
            const now = Date.now();
            let totalCleaned = 0;
            
            for (let farmId = 1; farmId <= 3; farmId++) {
                const logs = farmLogs[farmId] || [];
                if (logs.length === 0) continue;
                
                // ìµœëŒ€ ê°œìˆ˜ ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ë¡œê·¸ ë¶„ë¦¬
                if (logs.length > LOG_CONFIG.maxLogsPerFarm) {
                    const oldLogs = logs.slice(LOG_CONFIG.maxLogsPerFarm);  // ì‚­ì œë  ì˜¤ë˜ëœ ë¡œê·¸
                    const validLogs = logs.slice(0, LOG_CONFIG.maxLogsPerFarm);  // ìœ ì§€í•  ë¡œê·¸
                    
                    // ì •ë¦¬ ì „ì— ì˜¤ë˜ëœ ë¡œê·¸ë¥¼ ìë™ ì €ì¥
                    if (LOG_CONFIG.autoSaveBeforeCleanup && oldLogs.length > 0) {
                        await autoSaveOldLogs(farmId, oldLogs);
                        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ê°„ ì§€ì—°
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    farmLogs[farmId] = validLogs;
                    totalCleaned += oldLogs.length;
                }
            }
            
            if (totalCleaned > 0) {
                console.log(`ğŸ§¹ ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬ ì™„ë£Œ: ${totalCleaned}ê°œ í•­ëª© ì‚­ì œ${LOG_CONFIG.autoSaveBeforeCleanup ? ' (ìë™ ì €ì¥ë¨)' : ''}`);
            }
        }
        
        // ë†ì¥ë³„ ë°ì´í„° ë¡œê·¸ ë³µì› (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ - ë°±ì—…ì—ì„œ ë³µì›)
        function restoreFarmDataLog(farmId) {
            if (!farmId) return;
            
            // ë©”ëª¨ë¦¬ì— ì´ë¯¸ ë¡œê·¸ê°€ ìˆìœ¼ë©´ ë³µì›í•˜ì§€ ì•ŠìŒ (ì‹¤ì‹œê°„ ë°ì´í„° ìœ ì§€)
            if (farmLogs[farmId] && farmLogs[farmId].length > 0) {
                displayFarmLog(farmId);
                return;
            }
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë³µì› (ë°±ì—…ì´ ìˆëŠ” ê²½ìš°)
            try {
                const savedLogHtml = localStorage.getItem(`farm_log_${farmId}`);
                if (savedLogHtml && savedLogHtml.trim() !== '') {
                    // HTMLì„ íŒŒì‹±í•˜ì—¬ ë¡œê·¸ í•­ëª©ë“¤ ì¶”ì¶œ
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = savedLogHtml;
                    const logEntries = tempDiv.querySelectorAll('.log-entry');
                    
                    farmLogs[farmId] = [];
                    logEntries.forEach(entry => {
                        farmLogs[farmId].push(entry.outerHTML);
                    });
                    
                    console.log(`âœ… ë†ì¥ ${farmId}ì˜ ë°ì´í„° ë¡œê·¸ ë³µì› ì™„ë£Œ (${farmLogs[farmId].length}ê°œ í•­ëª©)`);
                } else {
                    // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                    farmLogs[farmId] = [];
                    console.log(`â„¹ï¸ ë†ì¥ ${farmId}ì˜ ì €ì¥ëœ ë°ì´í„° ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤.`);
                }
                
                displayFarmLog(farmId);
            } catch (e) {
                console.error('ë°ì´í„° ë¡œê·¸ ë³µì› ì˜¤ë¥˜:', e);
                farmLogs[farmId] = [];
                displayFarmLog(farmId);
            }
        }
        
        // ë°ì´í„° ë¡œê·¸ ì—…ë°ì´íŠ¸ (í˜„ì¬ ì„ íƒëœ íŒœì˜ ë¡œê·¸ì—ë§Œ ì¶”ê°€)
        function updateDataLog(sensorData) {
            // ë¶„ì„ ëª¨ë“œê°€ ë¡œê·¸ íŒŒì¼ì´ë©´ ì‹¤ì‹œê°„ ë¡œê·¸ ì—…ë°ì´íŠ¸ ì¤‘ë‹¨
            if (analysisMode === 'logs') {
                return;
            }
            
            // í˜„ì¬ ì„ íƒëœ íŒœ í™•ì¸
            const currentFarm = sensorData.currentFarm || currentFarmData.currentFarm || 1;
            
            // ì„¼ì„œ ë°ì´í„°ë¥¼ ë¡œê·¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í•´ë‹¹ íŒœì˜ ë¡œê·¸ì— ì¶”ê°€
            if (sensorData && sensorData.sensors && sensorData.sensors.length > 0) {
                const now = new Date();
                const timestamp = now.getFullYear() + '. ' + (now.getMonth() + 1) + '. ' + now.getDate() + '. ' +
                                 (now.getHours() >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „') + ' ' +
                                 (now.getHours() > 12 ? now.getHours() - 12 : now.getHours()) + ':' +
                                 (now.getMinutes() < 10 ? '0' : '') + now.getMinutes() + ':' +
                                 (now.getSeconds() < 10 ? '0' : '') + now.getSeconds();
                
                // ì„¼ì„œ ê°’ ì¶”ì¶œ
                let temperature = null;
                let humidity = null;
                let light = null;
                let soilMoisture = null;
                
                sensorData.sensors.forEach(sensor => {
                    if (sensor.name === 'ì˜¨ë„') {
                        temperature = parseFloat(sensor.rawValue);
                    } else if (sensor.name === 'ìŠµë„') {
                        humidity = parseFloat(sensor.rawValue);
                    } else if (sensor.name === 'ì±„ê´‘') {
                        light = parseFloat(sensor.rawValue);
                    } else if (sensor.name === 'í† ì–‘ìŠµë„') {
                        soilMoisture = parseFloat(sensor.rawValue);
                    }
                });
                
                // ë¡œê·¸ í•­ëª© ìƒì„± (4ê°œ ì„¼ì„œ ëª¨ë‘ í¬í•¨)
                if (temperature !== null || humidity !== null || light !== null || soilMoisture !== null) {
                    let logHtml = `<div class="log-entry">`;
                    logHtml += `<span class="log-timestamp">[${timestamp}]</span>`;
                    
                    if (temperature !== null) {
                        logHtml += `<span class="log-data"><span class="log-label">ì˜¨ë„:</span> <span class="log-value">${temperature.toFixed(1)}Â°C</span></span>`;
                    }
                    if (humidity !== null) {
                        logHtml += `<span class="log-data"><span class="log-label">ìŠµë„:</span> <span class="log-value">${humidity.toFixed(1)}%</span></span>`;
                    }
                    if (light !== null) {
                        logHtml += `<span class="log-data"><span class="log-label">ì±„ê´‘:</span> <span class="log-value">${light.toFixed(1)}%</span></span>`;
                    }
                    if (soilMoisture !== null) {
                        logHtml += `<span class="log-data"><span class="log-label">í† ì–‘ ìŠµë„:</span> <span class="log-value">${soilMoisture.toFixed(1)}%</span></span>`;
                    }
                    logHtml += `</div>`;
                    
                    // í•´ë‹¹ íŒœì˜ ë¡œê·¸ ë°°ì—´ì— ì¶”ê°€ (ìµœì‹  ë°ì´í„°ê°€ ì•ì—)
                    if (!farmLogs[currentFarm]) {
                        farmLogs[currentFarm] = [];
                    }
                    farmLogs[currentFarm].unshift(logHtml);
                    
                    // ìµœëŒ€ ë¡œê·¸ ê°œìˆ˜ ì œí•œ (ì˜¤ë˜ëœ ë¡œê·¸ ìë™ ì‚­ì œ)
                    if (farmLogs[currentFarm].length > LOG_CONFIG.maxLogsPerFarm) {
                        farmLogs[currentFarm] = farmLogs[currentFarm].slice(0, LOG_CONFIG.maxLogsPerFarm);
                        console.log(`â„¹ï¸ íŒœ ${currentFarm}ì˜ ë¡œê·¸ê°€ ${LOG_CONFIG.maxLogsPerFarm}ê°œë¥¼ ì´ˆê³¼í•˜ì—¬ ì˜¤ë˜ëœ ë¡œê·¸ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`);
                    }
                    
                    // í˜„ì¬ ì„ íƒëœ íŒœì´ë©´ í™”ë©´ì— ì¦‰ì‹œ í‘œì‹œ
                    if (currentFarm === currentFarmData.currentFarm) {
                        displayFarmLog(currentFarm);
                    }
                }
            }
        }
        
        // í‰ê·  ë°ì´í„° ì—…ë°ì´íŠ¸
        function updateAverageData(sensorData) {
            // ë¶„ì„ ëª¨ë“œê°€ ë¡œê·¸ íŒŒì¼ì´ë©´ ì‹¤ì‹œê°„ í‰ê·  ì—…ë°ì´íŠ¸ ì¤‘ë‹¨
            if (analysisMode === 'logs') {
                return;
            }
            
            if (!sensorData || !sensorData.sensors) return;
            
            let tempSum = 0, tempCount = 0;
            let humiditySum = 0, humidityCount = 0;
            let lightSum = 0, lightCount = 0;
            let soilSum = 0, soilCount = 0;
            
            // ë¡œê·¸ì—ì„œ í‰ê·  ê³„ì‚° (ìµœê·¼ 10ê°œ í•­ëª©)
            const logEntries = document.querySelectorAll('.log-entry');
            const entriesToUse = Math.min(10, logEntries.length);
            
            for (let i = 0; i < entriesToUse; i++) {
                const entry = logEntries[i];
                const text = entry.textContent;
                
                // ì˜¨ë„ ì¶”ì¶œ (ìƒˆ í˜•ì‹: ì˜¨ë„:ê°’â„ƒ, ê¸°ì¡´ í˜•ì‹: ì˜¨ë„: ê°’Â°C)
                const tempMatch = text.match(/ì˜¨ë„:\s*([0-9.]+)[â„ƒÂ°C]/) || text.match(/ì˜¨ë„[^:]*\([^)]*?([0-9.]+)\s*[â„ƒÂ°C]/);
                if (tempMatch) {
                    tempSum += parseFloat(tempMatch[1]);
                    tempCount++;
                }
                
                // ìŠµë„ ì¶”ì¶œ (ìƒˆ í˜•ì‹: ìŠµë„:ê°’%, ê¸°ì¡´ í˜•ì‹: ìŠµë„: ê°’%)
                const humidityMatch = text.match(/ìŠµë„:\s*([0-9.]+)%/) || text.match(/ìŠµë„[^:]*\([^)]*?([0-9.]+)\s*%/);
                if (humidityMatch) {
                    humiditySum += parseFloat(humidityMatch[1]);
                    humidityCount++;
                }
                
                // ì±„ê´‘ ì¶”ì¶œ (ìƒˆ í˜•ì‹: ì±„ê´‘:ê°’%, ê¸°ì¡´ í˜•ì‹: ì±„ê´‘: ê°’%)
                const lightMatch = text.match(/ì±„ê´‘:\s*([0-9.]+)%/) || text.match(/ì±„ê´‘[^:]*\([^)]*?([0-9.]+)\s*%/);
                if (lightMatch) {
                    lightSum += parseFloat(lightMatch[1]);
                    lightCount++;
                }
                
                // í† ì–‘ìŠµë„ ì¶”ì¶œ (ìƒˆ í˜•ì‹: í† ì–‘ìŠµë„:ê°’%, ê¸°ì¡´ í˜•ì‹: í† ì–‘ ìŠµë„: ê°’% ë˜ëŠ” í† ì–‘ìŠµë„ ê°’ ë‚®ìŒ (ê°’%))
                const soilMatch = text.match(/í† ì–‘ìŠµë„:\s*([0-9.]+)%/) || 
                                 text.match(/í† ì–‘\s*ìŠµë„:\s*([0-9.]+)%/) || 
                                 text.match(/í† ì–‘ìŠµë„[^:]*\([^)]*?([0-9.]+)\s*%/);
                if (soilMatch) {
                    soilSum += parseFloat(soilMatch[1]);
                    soilCount++;
                }
            }
            
            // í‰ê· ê°’ í‘œì‹œ
            document.getElementById('avgTemperature').textContent = 
                tempCount > 0 ? (tempSum / tempCount).toFixed(2) + 'Â°C' : '-';
            document.getElementById('avgHumidity').textContent = 
                humidityCount > 0 ? (humiditySum / humidityCount).toFixed(2) + '%' : '-';
            document.getElementById('avgLight').textContent = 
                lightCount > 0 ? (lightSum / lightCount).toFixed(2) + '%' : '-';
            document.getElementById('avgSoilMoisture').textContent = 
                soilCount > 0 ? (soilSum / soilCount).toFixed(2) + '%' : '-';
        }
        
        // ì „ì—­ ë³€ìˆ˜
        let loadedLogData = null;  // ë¶ˆëŸ¬ì˜¨ ë¡œê·¸ ë°ì´í„°
        let analysisMode = 'realtime';  // 'realtime' ë˜ëŠ” 'logs'
        // currentFarmDataëŠ” ìœ„ì—ì„œ ì´ë¯¸ ì •ì˜ë¨ (ì¤‘ë³µ ì œê±°)
        
        // ë¡œê·¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadLogFile() {
            document.getElementById('logFileInput').click();
        }
        
        // ë¡œê·¸ íŒŒì¼ ì„ íƒ ì²˜ë¦¬
        function handleLogFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                loadedLogData = content;
                
                // ë¡œê·¸ ë°ì´í„°ë¥¼ UIì— í‘œì‹œ
                displayLogData(content);
                
                // ë¡œê·¸ ë°ì´í„°ë¥¼ ê·¸ë˜í”„ì— í‘œì‹œ
                updateChartFromLogs(content);
                
                // ë¶„ì„ ëª¨ë“œë¥¼ ë¡œê·¸ íŒŒì¼ë¡œ ë³€ê²½
                document.getElementById('analysisMode').value = 'logs';
                analysisMode = 'logs';
                
                alert('ë¡œê·¸ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤.\nì´ì œ AI ë¶„ì„ ì‹œ ë¡œê·¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        // ë¡œê·¸ ë°ì´í„°ë¥¼ UIì— í‘œì‹œ
        function displayLogData(content) {
            const lines = content.split('\n');
            const container = document.getElementById('dataLogContent');
            container.innerHTML = '';
            
            lines.slice(0, 50).forEach(line => {
                if (line.trim()) {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    logEntry.textContent = line.trim();
                    container.appendChild(logEntry);
                }
            });
        }
        
        // ë¡œê·¸ íŒŒì¼ ì €ì¥ (ëª¨ë“  íŒœì˜ ë¡œê·¸ë¥¼ ê°ê° ë³„ë„ íŒŒì¼ë¡œ ì €ì¥)
        async function saveLogFile() {
            const farms = currentFarmData.farms || [];
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            let savedCount = 0;
            let savedFiles = [];
            
            // 1ë²ˆë¶€í„° 3ë²ˆê¹Œì§€ ëª¨ë“  íŒœ í™•ì¸
            for (let farmId = 1; farmId <= 3; farmId++) {
                try {
                    // ë©”ëª¨ë¦¬ì—ì„œ í•´ë‹¹ íŒœì˜ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
                    const logs = farmLogs[farmId] || [];
                    
                    if (logs.length > 0) {
                        // ë¡œê·¸ í•­ëª©ë“¤ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
                        let logContent = '';
                        logs.forEach(logHtml => {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = logHtml;
                            const logEntry = tempDiv.querySelector('.log-entry');
                            if (logEntry) {
                                logContent += logEntry.textContent + '\n';
                            }
                        });
                        
                        if (logContent.trim() !== '') {
                            // ë†ì¥ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                            const farmInfo = farms.find(f => f.id === farmId);
                            const cropName = farmInfo ? (farmInfo.cropName || 'ê¸°ë³¸') : 'ê¸°ë³¸';
                            
                            // íŒŒì¼ë¡œ ì €ì¥
                            const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `SmartFarm_íŒœ${farmId}_${cropName}_${timestamp}.txt`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            
                            savedCount++;
                            savedFiles.push(`íŒœ${farmId}_${cropName} (${logs.length}ê°œ í•­ëª©)`);
                            
                            // ì—¬ëŸ¬ íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° (ë¸Œë¼ìš°ì €ê°€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ì²˜ë¦¬í•  ì‹œê°„)
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    }
                } catch (e) {
                    console.error(`íŒœ ${farmId} ë¡œê·¸ ì €ì¥ ì˜¤ë¥˜:`, e);
                }
            }
            
            if (savedCount === 0) {
                alert('ì €ì¥í•  ë¡œê·¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nê° íŒœì— ë°ì´í„° ë¡œê·¸ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
            } else {
                alert(`ë¡œê·¸ íŒŒì¼ ${savedCount}ê°œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì €ì¥ëœ íŒŒì¼:\n${savedFiles.join('\n')}`);
            }
        }
        
        // ë¶„ì„ ëª¨ë“œ ë³€ê²½
        function onAnalysisModeChange() {
            const mode = document.getElementById('analysisMode').value;
            analysisMode = mode;
            
            if (mode === 'logs' && !loadedLogData) {
                alert('ë¡œê·¸ íŒŒì¼ì„ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.');
                document.getElementById('analysisMode').value = 'realtime';
                analysisMode = 'realtime';
                return;
            }
            
            // ëª¨ë“œ ë³€ê²½ ì‹œ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
            if (mode === 'logs' && loadedLogData) {
                updateChartFromLogs(loadedLogData);
            } else if (mode === 'realtime') {
                // ì‹¤ì‹œê°„ ëª¨ë“œë¡œ ì „í™˜ ì‹œ ê·¸ë˜í”„ ì´ˆê¸°í™”
                resetChart();
            }
        }
        
        // AI ë¶„ì„ í•¨ìˆ˜ë“¤ (í˜„ì¬ ì‘ë¬¼ì— ë§ì¶¤)
        function analyzeAverage() {
            const currentFarm = currentFarmData.currentFarm || 1;
            const farms = currentFarmData.farms || [];
            const currentFarmInfo = farms.find(f => f.id === currentFarm);
            const cropName = currentFarmInfo ? (currentFarmInfo.cropName || 'ê¸°ë³¸') : 'ê¸°ë³¸';
            const farmTitle = `ìŠ¤ë§ˆíŠ¸íŒœ ${currentFarm}ë²ˆ - ${cropName}`;
            
            showResult(`í‰ê·  ë°ì´í„° ë¶„ì„ (${farmTitle})`, 'ë¶„ì„ ì¤‘...');
            
            // ë¶„ì„ ëª¨ë“œì— ë”°ë¼ ìš”ì²­ ë°ì´í„° êµ¬ì„±
            let requestData = { 
                days: 7,
                farm_id: currentFarm  // í˜„ì¬ ë†ì¥ ID ì „ì†¡
            };
            if (analysisMode === 'logs' && loadedLogData) {
                requestData.use_logs = true;
                requestData.log_data = loadedLogData;
            }
            
            fetch('/api/ai/average', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    let result = `ğŸ ${data.crop_type || 'ì‚¬ê³¼'} ì¬ë°° í‰ê·  ë°ì´í„° ë¶„ì„ ê²°ê³¼\n`;
                    result += `ë¶„ì„ ê¸°ê°„: ìµœê·¼ ${data.period_days || 7}ì¼\n`;
                    result += `ë°ì´í„° ìˆ˜: ${data.data_count || 0}ê°œ\n`;
                    result += `ì „ì²´ í™˜ê²½ ì ìˆ˜: ${((data.overall_score || 0) * 100).toFixed(1)}%\n\n`;
                    result += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
                    
                    // ìŠµë„ ë¶„ì„
                    if (data.humidity) {
                        result += `ğŸ“Š ìŠµë„ ë¶„ì„:\n`;
                        result += `  í‰ê· : ${data.humidity.average?.toFixed(2) || 0}%`;
                        result += ` (ìµœì†Œ: ${data.humidity.min?.toFixed(2) || 0}%, ìµœëŒ€: ${data.humidity.max?.toFixed(2) || 0}%)\n`;
                        result += `  ${cropName} ì¬ë°° ìµœì  ë²”ìœ„: ${data.humidity.optimal_range || '60-80%'}\n`;
                        result += `  í˜„ì¬ ìƒíƒœ: ${data.humidity.status || 'ì •ìƒ'} (ì ìˆ˜: ${((data.humidity.optimal_score || 0) * 100).toFixed(1)}%)\n\n`;
                    }
                    
                    // ì˜¨ë„ ë¶„ì„
                    if (data.temperature) {
                        result += `ğŸŒ¡ï¸ ì˜¨ë„ ë¶„ì„:\n`;
                        result += `  í‰ê· : ${data.temperature.average?.toFixed(2) || 0}â„ƒ`;
                        result += ` (ìµœì†Œ: ${data.temperature.min?.toFixed(2) || 0}â„ƒ, ìµœëŒ€: ${data.temperature.max?.toFixed(2) || 0}â„ƒ)\n`;
                        result += `  ${cropName} ì¬ë°° ìµœì  ë²”ìœ„: ${data.temperature.optimal_range || '15-25â„ƒ'}\n`;
                        result += `  í˜„ì¬ ìƒíƒœ: ${data.temperature.status || 'ì •ìƒ'} (ì ìˆ˜: ${((data.temperature.optimal_score || 0) * 100).toFixed(1)}%)\n\n`;
                    }
                    
                    // ì±„ê´‘ ë¶„ì„
                    if (data.light) {
                        result += `â˜€ï¸ ì±„ê´‘ ë¶„ì„:\n`;
                        result += `  í‰ê· : ${data.light.average?.toFixed(2) || 0}%`;
                        result += ` (ìµœì†Œ: ${data.light.min?.toFixed(2) || 0}%, ìµœëŒ€: ${data.light.max?.toFixed(2) || 0}%)\n`;
                        result += `  ${cropName} ì¬ë°° ìµœì  ë²”ìœ„: ${data.light.optimal_range || '60-80%'}\n`;
                        result += `  í˜„ì¬ ìƒíƒœ: ${data.light.status || 'ì •ìƒ'} (ì ìˆ˜: ${((data.light.optimal_score || 0) * 100).toFixed(1)}%)\n\n`;
                    }
                    
                    // í† ì–‘ìŠµë„ ë¶„ì„
                    if (data.soil_moisture) {
                        result += `ğŸ’§ í† ì–‘ìŠµë„ ë¶„ì„:\n`;
                        result += `  í‰ê· : ${data.soil_moisture.average?.toFixed(2) || 0}%`;
                        result += ` (ìµœì†Œ: ${data.soil_moisture.min?.toFixed(2) || 0}%, ìµœëŒ€: ${data.soil_moisture.max?.toFixed(2) || 0}%)\n`;
                        result += `  ${cropName} ì¬ë°° ìµœì  ë²”ìœ„: ${data.soil_moisture.optimal_range || '40-60%'}\n`;
                        result += `  í˜„ì¬ ìƒíƒœ: ${data.soil_moisture.status || 'ì •ìƒ'} (ì ìˆ˜: ${((data.soil_moisture.optimal_score || 0) * 100).toFixed(1)}%)\n\n`;
                    }
                    
                    if (data.recommendations && data.recommendations.length > 0) {
                        result += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                        result += `ğŸ’¡ ${cropName} ì¬ë°° ê°œì„  ì¶”ì²œì‚¬í•­:\n`;
                        data.recommendations.forEach((rec, idx) => {
                            result += `${idx + 1}. ${rec}\n`;
                        });
                    }
                    
                    showResult(`í‰ê·  ë°ì´í„° ë¶„ì„ (${farmTitle})`, result);
                })
                .catch(error => {
                    showResult('í‰ê·  ë°ì´í„° ë¶„ì„ ì˜¤ë¥˜', 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
        }
        
        function detectAnomalies() {
            const currentFarm = currentFarmData.currentFarm || 1;
            const farms = currentFarmData.farms || [];
            const currentFarmInfo = farms.find(f => f.id === currentFarm);
            const cropName = currentFarmInfo ? (currentFarmInfo.cropName || 'ê¸°ë³¸') : 'ê¸°ë³¸';
            const farmTitle = `ìŠ¤ë§ˆíŠ¸íŒœ ${currentFarm}ë²ˆ - ${cropName}`;
            
            showResult(`ì´ìƒ ì§•í›„ ê°ì§€ (${farmTitle})`, 'ê°ì§€ ì¤‘...');
            
            // ë¶„ì„ ëª¨ë“œì— ë”°ë¼ ìš”ì²­ ë°ì´í„° êµ¬ì„±
            let requestData = { 
                days: 7,
                farm_id: currentFarm  // í˜„ì¬ ë†ì¥ ID ì „ì†¡
            };
            if (analysisMode === 'logs' && loadedLogData) {
                requestData.use_logs = true;
                requestData.log_data = loadedLogData;
            }
            
            fetch('/api/ai/anomaly', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    let result = `âš ï¸ ${data.crop_type || 'ì‚¬ê³¼'} ì¬ë°° ì´ìƒ ì§•í›„ ê°ì§€ ê²°ê³¼\n`;
                    result += `ë¶„ì„ ê¸°ê°„: ìµœê·¼ ${data.period_days || 7}ì¼\n`;
                    result += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
                    result += `ì´ ì´ìƒ ì§•í›„: ${data.total_anomalies || 0}ê°œ\n`;
                    result += `  ğŸ”´ ìœ„í—˜ (ë†’ìŒ): ${data.critical_count || 0}ê°œ\n`;
                    result += `  ğŸŸ¡ ì£¼ì˜ (ì¤‘ê°„): ${data.warning_count || 0}ê°œ\n\n`;
                    
                    if (data.summary) {
                        result += 'ì„¼ì„œë³„ ì´ìƒ ì§•í›„ í˜„í™©:\n';
                        result += `  ìŠµë„ ì´ìƒ: ${data.summary.humidity_anomalies || 0}ê°œ\n`;
                        result += `  ì˜¨ë„ ì´ìƒ: ${data.summary.temperature_anomalies || 0}ê°œ\n`;
                        result += `  ì±„ê´‘ ì´ìƒ: ${data.summary.light_anomalies || 0}ê°œ\n`;
                        result += `  í† ì–‘ìŠµë„ ì´ìƒ: ${data.summary.soil_moisture_anomalies || 0}ê°œ\n\n`;
                    }
                    
                    if (data.anomalies && data.anomalies.length > 0) {
                        result += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                        result += 'ì£¼ìš” ì´ìƒ ì§•í›„ ëª©ë¡:\n\n';
                        
                        // ìœ„í—˜ë„ ë†’ì€ ê²ƒë¶€í„° ì •ë ¬
                        const sortedAnomalies = [...data.anomalies].sort((a, b) => {
                            if (a.severity === 'ë†’ìŒ' && b.severity !== 'ë†’ìŒ') return -1;
                            if (a.severity !== 'ë†’ìŒ' && b.severity === 'ë†’ìŒ') return 1;
                            return 0;
                        });
                        
                        sortedAnomalies.slice(0, 10).forEach((anomaly, idx) => {
                            const severityIcon = anomaly.severity === 'ë†’ìŒ' ? 'ğŸ”´' : 'ğŸŸ¡';
                            result += `${severityIcon} ${idx + 1}. ${anomaly.sensor}\n`;
                            result += `   ì‹œê°„: ${anomaly.timestamp || '-'}\n`;
                            result += `   ê°’: ${anomaly.value?.toFixed(2) || 0}\n`;
                            result += `   ì›ì¸: ${anomaly.reason || anomaly.message || '-'}\n`;
                            if (anomaly.optimal_min !== undefined && anomaly.optimal_max !== undefined) {
                                result += `   ${cropName} ìµœì  ë²”ìœ„: ${anomaly.optimal_min}-${anomaly.optimal_max}\n`;
                            }
                            result += '\n';
                        });
                        
                        if (data.anomalies.length > 10) {
                            result += `... ì™¸ ${data.anomalies.length - 10}ê°œ ì´ìƒ ì§•í›„\n`;
                        }
                    } else {
                        result += 'âœ… ì´ìƒ ì§•í›„ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n';
                        result += 'ì‚¬ê³¼ ì¬ë°°ì— ì í•©í•œ í™˜ê²½ ì¡°ê±´ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.';
                    }
                    showResult(`ì´ìƒ ì§•í›„ ê°ì§€ (${farmTitle})`, result);
                })
                .catch(error => {
                    showResult('ì´ìƒ ì§•í›„ ê°ì§€ ì˜¤ë¥˜', 'ê°ì§€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
        }
        
        function showResult(title, content) {
            const container = document.getElementById('resultContainer');
            const titleEl = document.getElementById('resultTitle');
            const contentEl = document.getElementById('resultContent');
            
            titleEl.textContent = title;
            contentEl.textContent = content;
            container.classList.add('active');
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ
            container.scrollTop = 0;
        }
        
        // ê·¸ë˜í”„ ì´ˆê¸°í™”
        let sensorChart = null;
        let chartData = {
            labels: [],
            datasets: [
                {
                    label: 'ì˜¨ë„ (â„ƒ)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'ìŠµë„ (%)',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'ì±„ê´‘ (%)',
                    data: [],
                    borderColor: 'rgb(255, 206, 86)',
                    backgroundColor: 'rgba(255, 206, 86, 0.2)',
                    tension: 0.4,
                    yAxisID: 'y',
                    spanGaps: false,  // null ê°’ ì‚¬ì´ì˜ ê°„ê²©ì„ ì—°ê²°í•˜ì§€ ì•ŠìŒ
                    pointRadius: 3,
                    pointHoverRadius: 5
                },
                {
                    label: 'í† ì–‘ìŠµë„ (%)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4,
                    yAxisID: 'y'
                }
            ]
        };
        
        function initChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 10,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            enabled: true
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'ì‹œê°„'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ê°’'
                            },
                            beginAtZero: false
                        }
                    }
                }
            });
        }
        
        function updateChart(sensorData) {
            // ë¶„ì„ ëª¨ë“œê°€ ë¡œê·¸ íŒŒì¼ì´ë©´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í•˜ì§€ ì•ŠìŒ
            if (analysisMode === 'logs') {
                return;
            }
            
            if (!sensorChart) {
                initChart();
            }
            
            if (!sensorData || !sensorData.sensors) return;
            
            // í˜„ì¬ ì‹œê°„
            const now = new Date();
            const timeLabel = (now.getHours() < 10 ? '0' : '') + now.getHours() + ':' +
                            (now.getMinutes() < 10 ? '0' : '') + now.getMinutes() + ':' +
                            (now.getSeconds() < 10 ? '0' : '') + now.getSeconds();
            
            // ì„¼ì„œ ë°ì´í„° ì¶”ì¶œ
            let temperature = null;
            let humidity = null;
            let light = null;
            let soilMoisture = null;
            
            sensorData.sensors.forEach(sensor => {
                if (sensor.name === 'ì˜¨ë„') {
                    temperature = parseFloat(sensor.rawValue);
                } else if (sensor.name === 'ìŠµë„') {
                    humidity = parseFloat(sensor.rawValue);
                } else if (sensor.name === 'ì±„ê´‘') {
                    light = parseFloat(sensor.rawValue);
                    // ë””ë²„ê¹…: ì±„ê´‘ ë°ì´í„° í™•ì¸
                    console.log('ğŸ” ì±„ê´‘ ë°ì´í„°:', sensor, 'íŒŒì‹±ëœ ê°’:', light);
                } else if (sensor.name === 'í† ì–‘ìŠµë„') {
                    soilMoisture = parseFloat(sensor.rawValue);
                }
            });
            
            // ë””ë²„ê¹…: ëª¨ë“  ì„¼ì„œ ë°ì´í„° í™•ì¸
            console.log('ğŸ” ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ - ì˜¨ë„:', temperature, 'ìŠµë„:', humidity, 'ì±„ê´‘:', light, 'í† ì–‘ìŠµë„:', soilMoisture);
            
            // ë°ì´í„° ì¶”ê°€ (ì±„ê´‘ì´ 0ì´ì–´ë„ ìœ íš¨í•œ ê°’ì´ë¯€ë¡œ í¬í•¨)
            if (temperature !== null || humidity !== null || (light !== null && !isNaN(light)) || soilMoisture !== null) {
                // ì‹œê°„ ë ˆì´ë¸” ì¶”ê°€ (ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ìœ ì§€)
                chartData.labels.push(timeLabel);
                if (chartData.labels.length > 20) {
                    chartData.labels.shift();
                }
                
                // ì˜¨ë„ ë°ì´í„°
                chartData.datasets[0].data.push(temperature !== null && !isNaN(temperature) ? temperature : null);
                if (chartData.datasets[0].data.length > 20) {
                    chartData.datasets[0].data.shift();
                }
                
                // ìŠµë„ ë°ì´í„°
                chartData.datasets[1].data.push(humidity !== null && !isNaN(humidity) ? humidity : null);
                if (chartData.datasets[1].data.length > 20) {
                    chartData.datasets[1].data.shift();
                }
                
                // ì±„ê´‘ ë°ì´í„° (0ë„ ìœ íš¨í•œ ê°’ì´ë¯€ë¡œ í¬í•¨)
                const lightValue = (light !== null && !isNaN(light)) ? light : null;
                chartData.datasets[2].data.push(lightValue);
                console.log('ğŸ” ì±„ê´‘ ê·¸ë˜í”„ ë°ì´í„° ì¶”ê°€:', lightValue, 'ì „ì²´ ë°ì´í„°:', chartData.datasets[2].data);
                if (chartData.datasets[2].data.length > 20) {
                    chartData.datasets[2].data.shift();
                }
                
                // í† ì–‘ìŠµë„ ë°ì´í„°
                chartData.datasets[3].data.push(soilMoisture !== null && !isNaN(soilMoisture) ? soilMoisture : null);
                if (chartData.datasets[3].data.length > 20) {
                    chartData.datasets[3].data.shift();
                }
                
                // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
                sensorChart.update('none');  // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì—…ë°ì´íŠ¸
            }
        }
        
        // ë¡œê·¸ ë°ì´í„°ì—ì„œ ê·¸ë˜í”„ ë°ì´í„° ì¶”ì¶œ
        function updateChartFromLogs(logContent) {
            if (!sensorChart) {
                initChart();
            }
            
            const lines = logContent.split('\n');
            const logEntries = [];
            
            // ë¡œê·¸ì—ì„œ ì„¼ì„œ ë°ì´í„° ì¶”ì¶œ
            lines.forEach(line => {
                if (!line.trim()) return;
                
                // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ì¶œ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
                // í˜•ì‹ 1: [HH:MM:SS]
                let timeMatch = line.match(/\[(\d{2}:\d{2}:\d{2})\]/);
                let timeLabel = null;
                
                if (timeMatch) {
                    timeLabel = timeMatch[1];
                } else {
                    // í˜•ì‹ 2: [2025. 11. 19. ì˜¤í›„ 5:19:41]
                    const fullTimeMatch = line.match(/\[(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.\s*(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{2}):(\d{2})\]/);
                    if (fullTimeMatch) {
                        let hour = parseInt(fullTimeMatch[5]);
                        const ampm = fullTimeMatch[4];
                        if (ampm === 'ì˜¤í›„' && hour !== 12) hour += 12;
                        if (ampm === 'ì˜¤ì „' && hour === 12) hour = 0;
                        timeLabel = `${hour.toString().padStart(2, '0')}:${fullTimeMatch[6]}:${fullTimeMatch[7]}`;
                    } else {
                        return; // íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                    }
                }
                
                // ì„¼ì„œ ë°ì´í„° ì¶”ì¶œ (ìƒˆ í˜•ì‹ ìš°ì„ )
                let temperatureMatch, humidityMatch, lightMatch, soilMatch;
                
                if (line.includes('ì„¼ì„œë°ì´í„°')) {
                    // í˜•ì‹ 1: ì›¹ í‘œì¤€ í˜•ì‹ - ì„¼ì„œë°ì´í„° ìŠµë„:ê°’% ì˜¨ë„:ê°’â„ƒ ì±„ê´‘:ê°’% í† ì–‘ìŠµë„:ê°’%
                    temperatureMatch = line.match(/ì˜¨ë„:(\d+\.?\d*)\s*[â„ƒÂ°C]/);
                    humidityMatch = line.match(/ìŠµë„:(\d+\.?\d*)\s*%/);
                    lightMatch = line.match(/ì±„ê´‘:(\d+\.?\d*)\s*%/);
                    soilMatch = line.match(/í† ì–‘\s*ìŠµë„:(\d+\.?\d*)\s*%/);
                } else if (line.includes('ì˜¨ë„:') && line.includes('ìŠµë„:') && (line.includes('ì±„ê´‘:') || line.includes('í† ì–‘'))) {
                    // í˜•ì‹ 2: ì‹¤ì‹œê°„ ë°ì´í„° ì €ì¥ í˜•ì‹ - ì˜¨ë„:ê°’Â°CìŠµë„:ê°’%ì±„ê´‘:ê°’%í† ì–‘ ìŠµë„:ê°’%
                    temperatureMatch = line.match(/ì˜¨ë„:\s*(\d+\.?\d*)\s*[â„ƒÂ°C]/);
                    humidityMatch = line.match(/ìŠµë„:\s*(\d+\.?\d*)\s*%/);
                    lightMatch = line.match(/ì±„ê´‘:\s*(\d+\.?\d*)\s*%/);
                    soilMatch = line.match(/í† ì–‘\s*ìŠµë„:\s*(\d+\.?\d*)\s*%/);
                } else {
                    // ê¸°ì¡´ í˜•ì‹ ì§€ì› (í•˜ìœ„ í˜¸í™˜ì„±)
                    temperatureMatch = line.match(/ì˜¨ë„[^()]*\([^)]*?(\d+\.?\d*)\s*[â„ƒÂ°C]/);
                    humidityMatch = line.match(/ìŠµë„[^()]*\([^)]*?(\d+\.?\d*)\s*%/);
                    lightMatch = line.match(/ì±„ê´‘[^()]*?\([^)]*?(\d+\.?\d*)\s*%/);
                    soilMatch = line.match(/í† ì–‘ìŠµë„[^()]*?\([^)]*?(\d+\.?\d*)\s*%/);
                }
                
                if (temperatureMatch || humidityMatch || lightMatch || soilMatch) {
                    logEntries.push({
                        time: timeLabel,
                        temperature: temperatureMatch ? parseFloat(temperatureMatch[1]) : null,
                        humidity: humidityMatch ? parseFloat(humidityMatch[1]) : null,
                        light: lightMatch ? parseFloat(lightMatch[1]) : null,
                        soilMoisture: soilMatch ? parseFloat(soilMatch[1]) : null
                    });
                }
            });
            
            // ìµœëŒ€ 50ê°œê¹Œì§€ë§Œ ì‚¬ìš© (ìµœì‹  ë°ì´í„°)
            const entriesToUse = logEntries.slice(-50);
            
            // ê·¸ë˜í”„ ë°ì´í„° ì´ˆê¸°í™”
            chartData.labels = [];
            chartData.datasets[0].data = [];  // ì˜¨ë„
            chartData.datasets[1].data = [];  // ìŠµë„
            chartData.datasets[2].data = [];  // ì±„ê´‘
            chartData.datasets[3].data = [];  // í† ì–‘ìŠµë„
            
            // ë¡œê·¸ ë°ì´í„°ë¥¼ ê·¸ë˜í”„ì— ì¶”ê°€
            entriesToUse.forEach(entry => {
                chartData.labels.push(entry.time);
                chartData.datasets[0].data.push(entry.temperature);
                chartData.datasets[1].data.push(entry.humidity);
                chartData.datasets[2].data.push(entry.light);
                chartData.datasets[3].data.push(entry.soilMoisture);
            });
            
            // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
            sensorChart.update('none');
        }
        
        // ê·¸ë˜í”„ ì´ˆê¸°í™”
        function resetChart() {
            if (!sensorChart) {
                initChart();
                return;
            }
            
            chartData.labels = [];
            chartData.datasets[0].data = [];
            chartData.datasets[1].data = [];
            chartData.datasets[2].data = [];
            chartData.datasets[3].data = [];
            
            sensorChart.update('none');
        }
        
        // ê·¸ë˜í”„ ì´ˆê¸°í™”
        initChart();
        
        // ì´ˆê¸° ë†ì¥ ì •ë³´ ë¡œë“œ
        updateFarmInfo();
        
        // ì£¼ê¸°ì ìœ¼ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸ (2ì´ˆë§ˆë‹¤)
        // ë‹¨, ë¡œê·¸ ëª¨ë“œì¼ ë•ŒëŠ” ì¤‘ë‹¨ë¨ (updateSensorData ë‚´ë¶€ì—ì„œ ì²´í¬)
        setInterval(function() {
            if (analysisMode === 'realtime') {
                updateSensorData();
            }
        }, 2000);
        
        // ë†ì¥ ì •ë³´ ì—…ë°ì´íŠ¸ (10ì´ˆë§ˆë‹¤)
        setInterval(function() {
            updateFarmInfo();
        }, 10000);
        
        // ì´ˆê¸° ë¡œë“œ (ì‹¤ì‹œê°„ ëª¨ë“œì¼ ë•Œë§Œ)
        // í˜ì´ì§€ ë¡œë“œ í›„ ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ì‹¤í–‰
        setTimeout(function() {
            if (analysisMode === 'realtime') {
                updateSensorData();
            }
        }, 500);
        
        // ì£¼ê¸°ì ìœ¼ë¡œ ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬ (5ë¶„ë§ˆë‹¤)
        setInterval(function() {
            if (analysisMode === 'realtime') {
                cleanupOldLogs();
            }
        }, LOG_CONFIG.cleanupInterval);
    </script>
</body>
</html>
